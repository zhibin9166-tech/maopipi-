<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>票据&宠物买卖合同生成工具</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        .container { max-width: 850px; margin: 20px auto; }
        .form { margin: 0 0 30px 0; }
        .form div { margin: 12px 0; display: flex; align-items: center; gap: 10px; }
        .form label { width: 100px; font-size: 10.5px; color: #bd2626; }
        .form input, .form select { padding: 8px; flex: 1; border: 1px solid #ddd; border-radius: 4px; font-size: 10.5px; color: #bd2626; }
        .form textarea { padding: 8px; flex: 1; border: 1px solid #ddd; border-radius: 4px; resize: none; height: 56px; font-size: 14px; color: #bd2626; }
        .amount-group { display: flex; gap: 8px !important; align-items: center; }
        .amount-group select, .amount-group input { flex: none !important; }
        .amount-group select { width: 90px; }
        .amount-group input { width: 180px; }
        button { 
            padding: 10px 20px; background: #bd2626; color: #fff; 
            border: none; border-radius: 4px; cursor: pointer;
            margin-right: 10px; font-size: 10.5px;
        }
        button:hover { background: #a02020; }
        .button.secondary { background: #6c757d; }
        .button.secondary:hover { background: #5a6268; }
        .preview-title { font-size: 13.5px; font-weight: bold; color: #bd2626; margin: 40px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #bd2626; }
        .bill-code-suffix { width: 60px !important; text-align: center; }
        .bill-code-prefix { flex: none; width: 200px; color: #bd2626; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-size: 10.5px; }
        #ticketTemplate {
            width: 1588px;
            height: 2246px;
            margin: 20px auto;
            position: relative;
            background: url("https://17440061.s21i.faiusr.com/4/ABUIABAEGAAg47K3ywYowKnprQQwmiU4zzQ.png") no-repeat center center;
            background-size: cover;
            background-color: #fff;
            border: 1px solid #eee;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            will-change: background;
        }
        .ticket-text { 
            position: absolute; color: #bd2626; 
            font-family: "宋体", SimSun, sans-serif; 
            font-size: 24px;
            font-weight: bold;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
        .ticket-remark {
            font-size: 22px !important;
            white-space: normal;
            line-height: 1.4;
            width: 900px;
            font-family: "宋体", SimSun, sans-serif !important;
            font-weight: bold !important;
            color: #bd2626 !important;
        }
        .contract-page {
            width: 1588px;
            height: 2246px;
            margin: 20px auto;
            position: relative;
            background-color: #fff;
            border: 1px solid #eee;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            image-rendering: -webkit-optimize-contrast;
        }
        .contract-fill {
            position: absolute;
            font-family: "宋体", SimSun, sans-serif;
            font-size: 21px;
            color: #bd2626;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            max-width: 100%;
            -webkit-font-smoothing: antialiased;
        }
        .contract-fill-double {
            position: absolute;
            font-family: "宋体", SimSun, sans-serif;
            font-size: 21px;
            color: #bd2626;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 100%;
            -webkit-font-smoothing: antialiased;
        }
        .contract-fill-double span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #c_additional {
            line-height: 1.5;
            word-wrap: break-word;
            word-break: break-all;
            font-size: 21px !important;
            color: #bd2626 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form">
            <div><label>日期：</label><input type="date" id="date" value="2026-01-19" onchange="updateBillCodePrefix();updateAll()" oninput="updateBillCodePrefix();updateAll()"></div>
            <div>
                <label>票据编号：</label>
                <span class="bill-code-prefix" id="billCodePrefix">SJ20260119</span>
                <input type="number" id="billCodeSuffix" class="bill-code-suffix" placeholder="000" value="101" min="0" max="999" oninput="formatBillCodeSuffix();updateAll()" onchange="formatBillCodeSuffix();updateAll()">
                <input type="hidden" id="billNo" value="SJ20260119101">
            </div>
            <div><label>查询码：</label><input type="text" id="queryCode" placeholder="6位随机码，可手动修改" value="" oninput="updateAll()"></div>
            <div><label>付款人（甲方）：</label><input type="text" id="payer" value="Sophyybian" oninput="updateAll()"></div>
            <div><label>收款人（乙方）：</label><input type="text" id="seller" placeholder="请输入乙方姓名/名称" value="唐雪松" oninput="updateAll()"></div>
            <div><label>款项内容：</label><select id="payment" onchange="updateAll()">
                <option value="宠物排队定金">宠物排队定金</option>
                <option value="宠物购买押金">宠物购买押金</option>
                <option value="宠物购买尾款">宠物购买尾款</option>
            </select></div>
            <div class="amount-group"><label>金额（小）：</label>
                <select id="currency" value="CNY" onchange="updateAll()">
                    <option value="CNY">CNY（人民币）</option>
                    <option value="USD">USD（美金）</option>
                    <</option>
                    <option value="EUR">EUR（欧元）</option>
                    <option value="GBP">GBP（英镑）</option>
                </select>
                <input type="number" id="amountNum" value="2000.00" step="0.01" min="0" oninput="numToChinese();updateAll()">
            </div>
            <div><label>金额（大）：</label><input type="text" id="amountU" value="贰仟元整" readonly></div>
            <div><label>总价含运费：</label><select id="freight" onchange="updateAll()">
                <option value="包含">包含</option>
                <option value="不包含">不包含</option>
            </select></div>
            <div><label>备注1（补充）：</label><textarea id="remark1" placeholder="支持多行，同步至合同附加条款" oninput="updateAll()">无</textarea></div>
            <div><label>备注2（须知）：</label><input type="text" id="remark2" value="须知：排队定金不退不转，直到家长选到满意的小狗为止" oninput="updateAll()" style="font-size:14px;color:#bd2626;"></div>
            <div><label>&nbsp;</label>
                <button onclick="fillTicketOnly()">仅填充票据</button>
                <button onclick="genTicketPNG()">生成票据PNG</button>
                <button onclick="genTicketPDF()">生成票据PDF</button>
                <button class="secondary" onclick="fillContractOnly()">仅填充合同</button>
                <button class="secondary" onclick="genContractPDF()">生成合同PDF</button>
            </div>
        </div>

        <div class="preview-title">票据预览区</div>
        <div id="ticketTemplate">
            <div class="ticket-text" style="left:240px;top:309px;" id="t_date"></div>
            <div class="ticket-text" style="left:356px;top:350px;" id="t_billNo"></div>
            <div class="ticket-text" style="left:1312px;top:351px;" id="t_queryCode"></div>
            <div class="ticket-text" style="left:376px;top:413px;" id="t_payer"></div>
            <div class="ticket-text" style="left:376px;top:541px;" id="t_payment"></div>
            <div class="ticket-text" style="left:376px;top:665px;" id="t_amountL"></div>
            <div class="ticket-text" style="left:1060px;top:665px;" id="t_amountU"></div>
            <div class="ticket-text ticket-remark" style="left:376px;top:736px;" id="t_remark1"></div>
            <div class="ticket-text ticket-remark" style="left:376px;top:816px;" id="t_remark2"></div>
        </div>

        <div class="preview-title">合同预览区（第一页）</div>
        <div id="contractPage1" class="contract-page" style="background-image: url('https://17440061.s21i.faiusr.com/2/ABUIABACGAAg55i5ywYo8KSSuwEwmiU4zzQ.jpg');">
            <div class="contract-fill-double" style="left:350px;top:312px;width:320px;height:72px;" id="c_payer">
                <span></span><span></span>
            </div>
            <div class="contract-fill" style="left:350px;top:405px;width:320px;height:36px;" id="c_seller"></div>
            <div class="contract-fill" style="left:970px;top:321px;width:240px;height:36px;" id="c_billNo"></div>
            <div class="contract-fill" style="left:390px;top:1650px;width:360px;height:36px;" id="c_freight"></div>
            <div class="contract-fill" style="left:760px;top:670px;width:360px;height:36px;" id="c_deposit"></div>
            <div class="contract-fill" style="left:760px;top:720px;width:360px;height:36px;" id="c_balance"></div>
            <div class="contract-fill" style="left:360px;top:1300px;width:160px;height:36px;" id="c_transport"></div>
        </div>

        <div class="preview-title">合同预览区（第二页）</div>
        <div id="contractPage2" class="contract-page" style="background-image: url('https://17440061.s21i.faiusr.com/2/ABUIABACGAAggZm5ywYouM2KuQEwmiU4zzQ.png');">
            <div class="contract-fill" style="left:220px;top:980px;width:1160px;height:200px;" id="c_additional"></div>
            <div class="contract-fill" style="left:220px;top:1700px;width:320px;height:36px;" id="c_payerSign"></div>
            <div class="contract-fill" style="left:960px;top:1700px;width:320px;height:36px;" id="c_sellerSign"></div>
        </div>
    </div>

    <script>
        function generateQueryCode() {
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        function numToChinese() {
            const num = parseFloat(document.getElementById('amountNum').value);
            if (isNaN(num) || num < 0) {
                document.getElementById('amountU').value = "";
                return;
            }
            const digit = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const unit = ['', '拾', '佰', '仟', '万', '拾', '佰', '仟', '亿'];
            const [integer, decimal] = num.toFixed(2).split('.');
            let intStr = '';
            for (let i = 0; i < integer.length; i++) {
                const n = parseInt(integer[i]);
                const pos = integer.length - 1 - i;
                intStr += digit[n] + (n === 0 ? '' : unit[pos]);
            }
            intStr = intStr.replace(/零+/g, '零').replace(/零$/, '').replace(/^$/, '零');
            let chinese = intStr + '元';
            if (decimal === '00') {
                chinese += '整';
            } else {
                chinese += (decimal[0] !== '0' ? digit[parseInt(decimal[0])] + '角' : '');
                chinese += (decimal[1] !== '0' ? digit[parseInt(decimal[1])] + '分' : '');
            }
            document.getElementById('amountU').value = chinese;
        }

        function updateBillCodePrefix() {
            const dateVal = document.getElementById('date').value;
            const dateNoLine = dateVal ? dateVal.replace(/-/g, '') : '';
            const prefix = 'SJ' + dateNoLine;
            document.getElementById('billCodePrefix').innerText = prefix;
            formatBillCodeSuffix();
        }

        function formatBillCodeSuffix() {
            const prefix = document.getElementById('billCodePrefix').innerText;
            let suffix = document.getElementById('billCodeSuffix').value || '000';
            suffix = parseInt(suffix) || 0;
            suffix = suffix.toString().padStart(3, '0');
            document.getElementById('billCodeSuffix').value = suffix;
            const fullBillNo = prefix + suffix;
            document.getElementById('billNo').value = fullBillNo;
        }

        function fillTicketOnly() {
            const currency = document.getElementById('currency').value;
            const amountNum = parseFloat(document.getElementById('amountNum').value).toFixed(2);
            const amountLText = `${currency} ${amountNum}`;
            numToChinese();
            document.getElementById('t_date').innerText = document.getElementById('date').value;
            document.getElementById('t_billNo').innerText = document.getElementById('billNo').value;
            document.getElementById('t_queryCode').innerText = document.getElementById('queryCode').value;
            document.getElementById('t_payer').innerText = document.getElementById('payer').value;
            document.getElementById('t_payment').innerText = document.getElementById('payment').value;
            document.getElementById('t_amountL').innerText = amountLText;
            document.getElementById('t_amountU').innerText = document.getElementById('amountU').value;
            document.getElementById('t_remark1').innerText = document.getElementById('remark1').value;
            document.getElementById('t_remark2').innerText = document.getElementById('remark2').value;
            alert('票据数据填充完成！\n✅票据编号向上移4px（最终top=350px）\n✅其他字段位置保持不变');
        }

        function fillContractOnly() {
            const payer = document.getElementById('payer').value;
            const payerLines = document.querySelectorAll('#c_payer span');
            payerLines[0].innerText = payer.length > 8 ? payer.substring(0, 8) : payer;
            payerLines[1].innerText = payer.length > 8 ? payer.substring(8) : '';
            document.getElementById('c_billNo').innerText = document.getElementById('billNo').value;
            document.getElementById('c_seller').innerText = document.getElementById('seller').value || '唐雪松';
            document.getElementById('c_freight').innerText = document.getElementById('freight').value;
            document.getElementById('c_additional').innerText = document.getElementById('remark1').value || '无';
            alert('合同所有字段填充完成！\n✅甲方双行姓名（向上移2px）\n✅合同票据编号（累计向下移7px）\n✅乙方姓名（默认唐雪松）\n✅附加条款（与合同票据编号同样式）');
        }

        function genTicketPNG() {
            fillTicketOnly();
            html2canvas(document.getElementById('ticketTemplate'), {
                scale: 3,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#fff',
                letterRendering: true,
                logging: false,
                timeout: 5000,
                onclone: (cloneDoc) => {
                    const ticketClone = cloneDoc.getElementById('ticketTemplate');
                    ticketClone.style.backgroundImage = 'url("https://17440061.s21i.faiusr.com/4/ABUIABAEGAAg47K3ywYowKnprQQwmiU4zzQ.png")';
                    ticketClone.style.backgroundSize = 'cover';
                }
            }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png', 1.0);
                a.download = `票据_${document.getElementById('billNo').value}.png`;
                a.click();
            });
        }

        function genTicketPDF() {
            fillTicketOnly();
            html2canvas(document.getElementById('ticketTemplate'), {
                scale: 3,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#fff',
                letterRendering: true,
                logging: false,
                timeout: 5000,
                onclone: (cloneDoc) => {
                    const ticketClone = cloneDoc.getElementById('ticketTemplate');
                    ticketClone.style.backgroundImage = 'url("https://17440061.s21i.faiusr.com/4/ABUIABAEGAAg47K3ywYowKnprQQwmiU4zzQ.png")';
                    ticketClone.style.backgroundSize = 'cover';
                }
            }).then(canvas => {
                const pdf = new jspdf.jsPDF('p', 'px', [794, 1123]);
                pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, 794, 1123, '', 'FAST');
                // 票据PDF命名：MAOPIPI + 空格 + 票据编号 + 收款收据
                const ticketPdfName = `MAOPIPI ${document.getElementById('billNo').value} 收款收据.pdf`;
                pdf.save(ticketPdfName);
            });
        }

        // 修复核心：使用async/await规范异步执行顺序，确保第一页渲染完成后再处理第二页
        async function genContractPDF() {
            fillContractOnly();
            const pdf = new jspdf.jsPDF('p', 'px', [794, 1123]);
            
            // 先渲染合同第一页，等待渲染完成
            const canvas1 = await html2canvas(document.getElementById('contractPage1'), {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#fff',
                letterRendering: true,
                logging: false,
                timeout: 10000,
                onclone: (cloneDoc) => {
                    const contractClone = cloneDoc.getElementById('contractPage1');
                    contractClone.style.backgroundImage = 'url("https://17440061.s21i.faiusr.com/2/ABUIABACGAAg55i5ywYo8KSSuwEwmiU4zzQ.jpg")';
                    contractClone.style.backgroundSize = 'cover';
                }
            });
            pdf.addImage(canvas1.toDataURL('image/png', 1.0), 'PNG', 0, 0, 794, 1123, '', 'FAST');
            pdf.addPage();

            // 再渲染合同第二页，等待渲染完成
            const canvas2 = await html2canvas(document.getElementById('contractPage2'), {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#fff',
                letterRendering: true,
                logging: false,
                timeout: 10000,
                onclone: (cloneDoc) => {
                    const contractClone = cloneDoc.getElementById('contractPage2');
                    contractClone.style.backgroundImage = 'url("https://17440061.s21i.faiusr.com/2/ABUIABACGAAggZm5ywYouM2KuQEwmiU4zzQ.png")';
                    contractClone.style.backgroundSize = 'cover';
                }
            });
            pdf.addImage(canvas2.toDataURL('image/png', 1.0), 'PNG', 0, 0, 794, 1123, '', 'FAST');

            // 合同PDF命名：付款人 + 空格 + 票据编号 + 合同
            const contractPdfName = `${document.getElementById('payer').value} ${document.getElementById('billNo').value} 合同.pdf`;
            pdf.save(contractPdfName);
        }

        function updateAll() {
            const currency = document.getElementById('currency').value;
            const amountNum = parseFloat(document.getElementById('amountNum').value).toFixed(2);
            const amountLText = `${currency} ${amountNum}`;
            numToChinese();
            document.getElementById('t_date').innerText = document.getElementById('date').value;
            document.getElementById('t_billNo').innerText = document.getElementById('billNo').value;
            document.getElementById('t_queryCode').innerText = document.getElementById('queryCode').value;
            document.getElementById('t_payer').innerText = document.getElementById('payer').value;
            document.getElementById('t_payment').innerText = document.getElementById('payment').value;
            document.getElementById('t_amountL').innerText = amountLText;
            document.getElementById('t_amountU').innerText = document.getElementById('amountU').value;
            document.getElementById('t_remark1').innerText = document.getElementById('remark1').value;
            document.getElementById('t_remark2').innerText = document.getElementById('remark2').value;

            const payer = document.getElementById('payer').value;
            const payerLines = document.querySelectorAll('#c_payer span');
            payerLines[0].innerText = payer.length > 8 ? payer.substring(0, 8) : payer;
            payerLines[1].innerText = payer.length > 8 ? payer.substring(8) : '';
            document.getElementById('c_billNo').innerText = document.getElementById('billNo').value;
            document.getElementById('c_seller').innerText = document.getElementById('seller').value || '唐雪松';
            document.getElementById('c_freight').innerText = document.getElementById('freight').value;
            document.getElementById('c_additional').innerText = document.getElementById('remark1').value || '无';
        }

        window.onload = function() {
            document.getElementById('queryCode').value = generateQueryCode();
            updateBillCodePrefix();
            formatBillCodeSuffix();
            numToChinese();
            updateAll();
        }
    </script>
</body>
</html>
